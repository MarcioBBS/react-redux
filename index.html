<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>React - Redux</title>
  </head>
  <body style="padding: 20px">
    <h1>React - Redux</h1>
    <hr />
    <br />

    <div class="list">
      <input type="text" name="todo" id="todo" placeholder="Add Todo" />
      <button id="todoBtn">Add Todo</button>
      <ul id="todos"></ul>
    </div>

    <div class="list">
      <input type="text" name="goal" id="goal" placeholder="Add Goal" />
      <button id="goalBtn">Add Goal</button>
      <ul id="goals"></ul>
    </div>

    <script>
      function generateId() {
        return Math.random().toString(36).substring(2) + new Date().getTime().toString(36);
      }

      // LIBRARY CODE - The Store!
      /**
       *
       * @param {Pure Function} reducer
       * @returns
       */
      function createStore(reducer) {
        // The Store should have four paths
        // 1. The State
        // 2. Get the state
        // 3. Listen to changes on the state
        // 4. Update the state

        let state;
        let listeners = []; // Array of functions

        // 1. The State
        const getState = () => state;

        /**
         * 3. Listen to changes on the state
         * Takes in functions that will be called when the state changes
         * @param {function} listener
         * @returns function to unsubscribe
         */
        const subscribe = listener => {
          listeners.push(listener);

          return () => {
            listeners = listeners.filter(l => l !== listener);
          };
        };

        // 4. Update the state
        // Responsible to update the sate inside of the actual Store - It needs to receive the Actiion to tell dispatch() the specific event that occurred inside of the applicaton
        const dispatch = action => {
          state = reducer(state, action);
          listeners.forEach(listener => listener()); // Invoke all Listener(function) inside of the array because the state has (potentially) changed.
        };

        return {
          getState,
          subscribe,
          dispatch,
        };
      }

      /***  Begin - Reducer functions  ***/

      const ADD_TODO = "ADD_TODO";
      const REMOVE_TODO = "REMOVE_TODO";
      const TOGGLE_TODO = "TOGGLE_TODO";
      const ADD_GOAL = "ADD_GOAL";
      const REMOVE_GOAL = "REMOVE_GOAL";

      // Action Creators
      const addTodoAction = todo => ({ type: ADD_TODO, todo });

      const removeTodoAction = id => ({ type: REMOVE_TODO, id });

      const toggleTodoAction = id => ({ type: TOGGLE_TODO, id });

      const addGoalAction = goal => ({ type: ADD_GOAL, goal });

      const removeGoalAction = id => ({ type: REMOVE_GOAL, id });
      // End - Action Creators

      // Root reducer
      // Whenever [dispatch] is called, we invoke our [app] function. The [app] function will then invoke the [todos] reducer as well as the [goals] reducer. Those will return their specific portions of the state. And then, the [app] function will return a state object with a [todos] property (the value of which is what the [todos] reducer returned) and a [goals] property (the value of which is what the [goals] reducer returned).
      function app(state = {}, action) {
        return {
          todos: todos(state.todos, action),
          goals: goals(state.goals, action),
        };
      }

      // APP Todos - Reducer
      //Passing the root reducer to our store since our createStore function can only take one reducer.
      function todos(state = [], action) {
        switch (action.type) {
          case ADD_TODO:
            return state.concat([action.todo]);
          case REMOVE_TODO:
            return state.filter(todo => todo.id !== action.id);
          case TOGGLE_TODO:
            return state.map(todo => (todo.id !== action.id ? todo : Object.assign({}, todo, { complete: !todo.complete })));
          default:
            return state;
        }
      }

      // App Goals - Reducer
      function goals(state = [], action) {
        switch (action.type) {
          case ADD_GOAL:
            return state.concat([action.goal]);
          case REMOVE_GOAL:
            return state.filter(goal => goal.id !== action.id);
          default:
            return state;
        }
      }
      /***  End - Reducer functions  ***/

      // Create the STORE
      const store = createStore(app);

      // Lsiten for changes
      store.subscribe(() => {
        const { goals, todos } = store.getState();

        document.querySelector("#goals").innerHTML = "";
        document.querySelector("#todos").innerHTML = "";

        // Add items to the DOM
        goals.forEach(renderGoalToDOM);
        todos.forEach(renderTodoToDOM);
      });

      /*** DOM manipulation ***/
      // Add Todo
      function addTodo() {
        // Get the value from the UI
        const input = document.querySelector("#todo");
        const name = input.value;
        input.value = ""; // Reset the value

        // Add the todo to the state
        store.dispatch(
          addTodoAction({
            name,
            complete: false,
            id: generateId(),
          })
        );
      }

      // Add Goal
      function addGoal() {
        // Get the value from the UI
        const input = document.querySelector("#goal");
        const name = input.value;
        input.value = ""; // Reset the value

        // Add the goal to the state
        store.dispatch(
          addGoalAction({
            name,
            id: generateId(),
          })
        );
      }

      //Add new Todo
      document.querySelector("#todoBtn").addEventListener("click", addTodo);
      //Add new Goal
      document.querySelector("#goalBtn").addEventListener("click", addGoal);

      /**
       * Create button to remove item from the list
       * @param {callback function} onclick
       * @returns the button with the event listener embeeded
       */
      function createRemoveButton(onClick) {
        const removeBtn = document.createElement("button");
        removeBtn.innerHTML = " X ";
        removeBtn.addEventListener("click", onClick);
        return removeBtn;
      }

      function renderTodoToDOM(todo) {
        const node = document.createElement("li");
        const text = document.createTextNode(todo.name);
        const removeBtn = createRemoveButton(() => store.dispatch(removeTodoAction(todo.id)));

        node.appendChild(text);
        node.appendChild(removeBtn);

        node.style.textDecoration = todo.complete ? "line-through" : "none";
        node.addEventListener("click", () => store.dispatch(toggleTodoAction(todo.id)));

        document.querySelector("#todos").appendChild(node);
      }

      function renderGoalToDOM(goal) {
        const node = document.createElement("li");
        const text = document.createTextNode(goal.name);
        const removeBtn = createRemoveButton(() => store.dispatch(removeGoalAction(goal.id)));

        node.appendChild(text);
        node.appendChild(removeBtn);

        document.querySelector("#goals").appendChild(node);
      }

      /*** END- DOM manipulation ***/

      /***  TEST ***/
      // store.dispatch(
      //   addTodoAction({
      //     id: 0,
      //     name: "Walk the dog",
      //     complete: false,
      //   })
      // );

      // store.dispatch(
      //   addTodoAction({
      //     id: 1,
      //     name: "Wash the car",
      //     complete: false,
      //   })
      // );

      // store.dispatch(
      //   addTodoAction({
      //     id: 2,
      //     name: "Go to the gym",
      //     complete: true,
      //   })
      // );

      // store.dispatch(removeTodoAction(1));

      // store.dispatch(toggleTodoAction(0));

      // store.dispatch(
      //   addGoalAction({
      //     id: 0,
      //     name: "Learn Redux",
      //   })
      // );

      // store.dispatch(
      //   addGoalAction({
      //     id: 1,
      //     name: "Lose 20 pounds",
      //   })
      // );

      // store.dispatch(removeGoalAction(0));
    </script>
  </body>
</html>
